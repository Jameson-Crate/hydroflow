<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `/home/runner/work/hydroflow/hydroflow/target/debug/build/hydroflow_plus_cli_integration-cfad993d02020665/out/lib_pub.rs`."><title>lib_pub.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../../../../../../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../../../../../../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../../../../../../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../../../../../../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../../../../../../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../../../../../../../../../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../../../../../../../../../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../../../../../../../../../../static.files/rustdoc-9ee3a5e31a2afa3e.css"><meta name="rustdoc-vars" data-root-path="../../../../../../../../../../../../" data-static-root-path="../../../../../../../../../../../../static.files/" data-current-crate="hydroflow_plus_cli_integration" data-themes="" data-resource-suffix="" data-rustdoc-version="1.75.0-nightly (cd674d617 2023-10-24)" data-channel="nightly" data-search-js="search-8fbf244ebcf71464.js" data-settings-js="settings-74424d7eec62a23e.js" ><script src="../../../../../../../../../../../../static.files/storage-fec3eaa3851e447d.js"></script><script defer src="../../../../../../../../../../../../static.files/src-script-3280b574d94e47b4.js"></script><script defer src="../../../../../../../../../../../../src-files.js"></script><script defer src="../../../../../../../../../../../../static.files/main-5f34af1a0ee6bacd.js"></script><noscript><link rel="stylesheet" href="../../../../../../../../../../../../static.files/noscript-5d8b3c7633ad77ba.css"></noscript><link rel="alternate icon" type="image/png" href="../../../../../../../../../../../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../../../../../../../../../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../../../../../../../../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc src"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"></nav><main><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../../../../../../../../../../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../../../../../../../../../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../../../../../../../../../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="example-wrap"><div data-nosnippet><pre class="src-line-numbers"><a href="#1" id="1">1</a>
</pre></div><pre class="rust"><code><span class="kw">pub mod </span>runtime { <span class="kw">pub use </span>std :: cell :: RefCell ; <span class="kw">pub use </span>std :: rc :: Rc ; <span class="kw">pub use </span>hydroflow_plus :: lang :: parse :: Pipeline ; <span class="kw">pub use </span>hydroflow_plus :: node :: { ClusterBuilder , Deploy , HfCluster , HfNode , HfSendManyToMany , HfSendManyToOne , HfSendOneToMany , HfSendOneToOne , NodeBuilder , } ; <span class="kw">pub use </span>hydroflow_plus :: util :: cli :: { ConnectedDemux , ConnectedDirect , ConnectedSink , ConnectedSource , ConnectedTagged , HydroCLI , } ; <span class="kw">pub use </span>hydroflow_plus :: GraphBuilder ; <span class="kw">pub use </span>stageleft :: { q , Quoted , RuntimeData } ; <span class="kw">pub use </span>syn :: parse_quote ; <span class="kw">pub use super </span>:: HydroflowPlusMeta ; <span class="kw">pub use crate </span>:: runtime :: CLIRuntime ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; Deploy &lt; <span class="lifetime">&#39;a </span>&gt; <span class="kw">for </span>CLIRuntime { <span class="kw">type </span>Node = CLIRuntimeNode &lt; <span class="lifetime">&#39;a </span>&gt; ; <span class="kw">type </span>Cluster = CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; ; <span class="kw">type </span>Meta = () ; <span class="kw">type </span>RuntimeID = usize ; <span class="kw">type </span>NodePort = String ; <span class="kw">type </span>ClusterPort = String ; } <span class="kw">pub use crate </span>:: runtime :: CLIRuntimeNode ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfNode &lt; <span class="lifetime">&#39;a </span>&gt; <span class="kw">for </span>CLIRuntimeNode &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">type </span>Port = String ; <span class="kw">type </span>Meta = () ; <span class="kw">fn </span>id (&amp; <span class="self">self</span>) -&gt; usize { <span class="self">self </span>. id } <span class="kw">fn </span>graph_builder (&amp; <span class="self">self</span>) -&gt; (&amp; <span class="lifetime">&#39;a </span>RefCell &lt; usize &gt; , &amp; <span class="lifetime">&#39;a </span>hydroflow_plus :: builder :: Builders) { <span class="self">self </span>. builder . builder_components () } <span class="kw">fn </span>next_port (&amp; <span class="self">self</span>) -&gt; String { <span class="kw">let </span>next_send_port = * <span class="self">self </span>. next_port . borrow () ; * <span class="self">self </span>. next_port . borrow_mut () += <span class="number">1 </span>; format ! (<span class="string">&quot;port_{}&quot; </span>, next_send_port) } <span class="kw">fn </span>update_meta (&amp; <span class="kw-2">mut </span><span class="self">self </span>, _meta : &amp; <span class="self">Self </span>:: Meta) { } } <span class="kw">pub use crate </span>:: runtime :: CLIRuntimeCluster ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfNode &lt; <span class="lifetime">&#39;a </span>&gt; <span class="kw">for </span>CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">type </span>Port = String ; <span class="kw">type </span>Meta = () ; <span class="kw">fn </span>id (&amp; <span class="self">self</span>) -&gt; usize { <span class="self">self </span>. id } <span class="kw">fn </span>graph_builder (&amp; <span class="self">self</span>) -&gt; (&amp; <span class="lifetime">&#39;a </span>RefCell &lt; usize &gt; , &amp; <span class="lifetime">&#39;a </span>hydroflow_plus :: builder :: Builders) { <span class="self">self </span>. builder . builder_components () } <span class="kw">fn </span>next_port (&amp; <span class="self">self</span>) -&gt; String { <span class="kw">let </span>next_send_port = * <span class="self">self </span>. next_port . borrow () ; * <span class="self">self </span>. next_port . borrow_mut () += <span class="number">1 </span>; format ! (<span class="string">&quot;port_{}&quot; </span>, next_send_port) } <span class="kw">fn </span>update_meta (&amp; <span class="kw-2">mut </span><span class="self">self </span>, _meta : &amp; <span class="self">Self </span>:: Meta) { } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfCluster &lt; <span class="lifetime">&#39;a </span>&gt; <span class="kw">for </span>CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>ids (&amp; <span class="self">self</span>) -&gt; <span class="kw">impl </span>Quoted &lt; <span class="lifetime">&#39;a </span>, &amp; <span class="lifetime">&#39;a </span>Vec &lt; u32 &gt; &gt; + Copy + <span class="lifetime">&#39;a </span>{ <span class="kw">let </span>cli = <span class="self">self </span>. cli ; <span class="kw">let </span>self_id = <span class="self">self </span>. id ; q ! (cli . meta . clusters . get (&amp; self_id) . unwrap ()) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfSendOneToOne &lt; <span class="lifetime">&#39;a </span>, CLIRuntimeNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; <span class="kw">for </span>CLIRuntimeNode &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>connect (&amp; <span class="self">self </span>, _other : &amp; CLIRuntimeNode , _source_port : &amp; String , _recipient_port : &amp; String) { } <span class="kw">fn </span>gen_sink_statement (&amp; <span class="self">self </span>, port : &amp; String) -&gt; Pipeline { <span class="kw">let </span>self_cli = <span class="self">self </span>. cli ; <span class="kw">let </span>port = port . as_str () ; <span class="kw">let </span>sink_quote = q ! ({ self_cli . port (port) . connect_local_blocking ::&lt; ConnectedDirect &gt; () . into_sink () }) . splice () ; parse_quote ! (dest_sink (# sink_quote)) } <span class="kw">fn </span>gen_source_statement (other : &amp; CLIRuntimeNode &lt; <span class="lifetime">&#39;a </span>&gt; , port : &amp; String) -&gt; Pipeline { <span class="kw">let </span>self_cli = other . cli ; <span class="kw">let </span>port = port . as_str () ; <span class="kw">let </span>source_quote = q ! ({ self_cli . port (port) . connect_local_blocking ::&lt; ConnectedDirect &gt; () . into_source () }) . splice () ; parse_quote ! (source_stream (# source_quote)) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfSendManyToOne &lt; <span class="lifetime">&#39;a </span>, CLIRuntimeNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; <span class="kw">for </span>CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>connect (&amp; <span class="self">self </span>, _other : &amp; CLIRuntimeNode , _source_port : &amp; String , _recipient_port : &amp; String) { } <span class="kw">fn </span>gen_sink_statement (&amp; <span class="self">self </span>, port : &amp; String) -&gt; Pipeline { <span class="kw">let </span>self_cli = <span class="self">self </span>. cli ; <span class="kw">let </span>port = port . as_str () ; <span class="kw">let </span>sink_quote = q ! ({ self_cli . port (port) . connect_local_blocking ::&lt; ConnectedDirect &gt; () . into_sink () }) . splice () ; parse_quote ! (dest_sink (# sink_quote)) } <span class="kw">fn </span>gen_source_statement (other : &amp; CLIRuntimeNode &lt; <span class="lifetime">&#39;a </span>&gt; , port : &amp; String) -&gt; Pipeline { <span class="kw">let </span>self_cli = other . cli ; <span class="kw">let </span>port = port . as_str () ; <span class="kw">let </span>source_quote = q ! ({ self_cli . port (port) . connect_local_blocking ::&lt; ConnectedTagged &lt; ConnectedDirect &gt;&gt; () . into_source () }) . splice () ; parse_quote ! (source_stream (# source_quote)) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfSendOneToMany &lt; <span class="lifetime">&#39;a </span>, CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; <span class="kw">for </span>CLIRuntimeNode &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>connect (&amp; <span class="self">self </span>, _other : &amp; CLIRuntimeCluster , _source_port : &amp; String , _recipient_port : &amp; String) { } <span class="kw">fn </span>gen_sink_statement (&amp; <span class="self">self </span>, port : &amp; String) -&gt; Pipeline { <span class="kw">let </span>self_cli = <span class="self">self </span>. cli ; <span class="kw">let </span>port = port . as_str () ; <span class="kw">let </span>sink_quote = q ! ({ self_cli . port (port) . connect_local_blocking ::&lt; ConnectedDemux &lt; ConnectedDirect &gt;&gt; () . into_sink () }) . splice () ; parse_quote ! (dest_sink (# sink_quote)) } <span class="kw">fn </span>gen_source_statement (other : &amp; CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; , port : &amp; String) -&gt; Pipeline { <span class="kw">let </span>self_cli = other . cli ; <span class="kw">let </span>port = port . as_str () ; <span class="kw">let </span>source_quote = q ! ({ self_cli . port (port) . connect_local_blocking ::&lt; ConnectedDirect &gt; () . into_source () }) . splice () ; parse_quote ! (source_stream (# source_quote)) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfSendManyToMany &lt; <span class="lifetime">&#39;a </span>, CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; <span class="kw">for </span>CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>connect (&amp; <span class="self">self </span>, _other : &amp; CLIRuntimeCluster , _source_port : &amp; String , _recipient_port : &amp; String) { } <span class="kw">fn </span>gen_sink_statement (&amp; <span class="self">self </span>, port : &amp; String) -&gt; Pipeline { <span class="kw">let </span>self_cli = <span class="self">self </span>. cli ; <span class="kw">let </span>port = port . as_str () ; <span class="kw">let </span>sink_quote = q ! ({ self_cli . port (port) . connect_local_blocking ::&lt; ConnectedDemux &lt; ConnectedDirect &gt;&gt; () . into_sink () }) . splice () ; parse_quote ! (dest_sink (# sink_quote)) } <span class="kw">fn </span>gen_source_statement (other : &amp; CLIRuntimeCluster &lt; <span class="lifetime">&#39;a </span>&gt; , port : &amp; String) -&gt; Pipeline { <span class="kw">let </span>self_cli = other . cli ; <span class="kw">let </span>port = port . as_str () ; <span class="kw">let </span>source_quote = q ! ({ self_cli . port (port) . connect_local_blocking ::&lt; ConnectedTagged &lt; ConnectedDirect &gt;&gt; () . into_source () }) . splice () ; parse_quote ! (source_stream (# source_quote)) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;cli </span>&gt; NodeBuilder &lt; <span class="lifetime">&#39;cli </span>, CLIRuntime &gt; <span class="kw">for </span>RuntimeData &lt; &amp; <span class="lifetime">&#39;cli </span>HydroCLI &lt; HydroflowPlusMeta &gt; &gt; { <span class="kw">fn </span>build (&amp; <span class="self">self </span>, id : usize , builder : &amp; <span class="lifetime">&#39;cli </span>GraphBuilder &lt; <span class="lifetime">&#39;cli </span>, CLIRuntime &gt; , _meta : &amp; <span class="kw-2">mut </span>() ,) -&gt; CLIRuntimeNode &lt; <span class="lifetime">&#39;cli </span>&gt; { CLIRuntimeNode { id , builder , next_port : Rc :: new (RefCell :: new (<span class="number">0</span>)) , cli : * <span class="self">self </span>, } } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;cli </span>&gt; ClusterBuilder &lt; <span class="lifetime">&#39;cli </span>, CLIRuntime &gt; <span class="kw">for </span>RuntimeData &lt; &amp; <span class="lifetime">&#39;cli </span>HydroCLI &lt; HydroflowPlusMeta &gt; &gt; { <span class="kw">fn </span>build (&amp; <span class="self">self </span>, id : usize , builder : &amp; <span class="lifetime">&#39;cli </span>GraphBuilder &lt; <span class="lifetime">&#39;cli </span>, CLIRuntime &gt; , _meta : &amp; <span class="kw-2">mut </span>() ,) -&gt; CLIRuntimeCluster &lt; <span class="lifetime">&#39;cli </span>&gt; { CLIRuntimeCluster { id , builder , next_port : Rc :: new (RefCell :: new (<span class="number">0</span>)) , cli : * <span class="self">self </span>, } } } } <span class="kw">pub use </span>std :: collections :: HashMap ; <span class="kw">pub use </span>runtime :: * ; # [cfg (feature = <span class="string">&quot;deploy&quot;</span>)] <span class="kw">pub mod </span>deploy { <span class="kw">pub use </span>std :: cell :: RefCell ; <span class="kw">pub use </span>std :: collections :: HashMap ; <span class="kw">pub use </span>std :: rc :: Rc ; <span class="kw">pub use </span>std :: sync :: Arc ; <span class="kw">pub use </span>async_channel :: Receiver ; <span class="kw">pub use </span>hydro_deploy :: custom_service :: CustomClientPort ; <span class="kw">pub use </span>hydro_deploy :: hydroflow_crate :: ports :: { DemuxSink , HydroflowSink , HydroflowSource , TaggedSource , } ; <span class="kw">pub use </span>hydro_deploy :: hydroflow_crate :: HydroflowCrateService ; <span class="kw">pub use </span>hydro_deploy :: { Deployment , Host } ; <span class="kw">pub use </span>hydroflow_plus :: builder :: Builders ; <span class="kw">pub use </span>hydroflow_plus :: node :: { ClusterBuilder , Deploy , HfCluster , HfNode , HfSendManyToMany , HfSendManyToOne , HfSendOneToMany , HfSendOneToOne , NodeBuilder , } ; <span class="kw">pub use </span>hydroflow_plus :: GraphBuilder ; <span class="kw">pub use </span>stageleft :: internal :: syn :: parse_quote ; <span class="kw">pub use </span>stageleft :: q ; <span class="kw">pub use </span>tokio :: sync :: RwLock ; <span class="kw">pub use super </span>:: HydroflowPlusMeta ; <span class="kw">pub use crate </span>:: deploy :: CLIDeploy ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; Deploy &lt; <span class="lifetime">&#39;a </span>&gt; <span class="kw">for </span>CLIDeploy { <span class="kw">type </span>Node = CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; ; <span class="kw">type </span>Cluster = CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; ; <span class="kw">type </span>Meta = HashMap &lt; usize , Vec &lt; u32 &gt; &gt; ; <span class="kw">type </span>RuntimeID = () ; <span class="kw">type </span>NodePort = CLIDeployPort &lt; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ; <span class="kw">type </span>ClusterPort = CLIDeployPort &lt; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ; } <span class="kw">pub use crate </span>:: deploy :: DeployCrateWrapper ; <span class="kw">pub use crate </span>:: deploy :: CLIDeployNode ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; DeployCrateWrapper <span class="kw">for </span>CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>underlying (&amp; <span class="self">self</span>) -&gt; Arc &lt; RwLock &lt; HydroflowCrateService &gt; &gt; { <span class="self">self </span>. underlying . clone () } } <span class="kw">pub use crate </span>:: deploy :: CLIDeployPort ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; CLIDeployPort &lt; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; { <span class="kw">pub async fn </span>create_sender (&amp; <span class="self">self </span>, deployment : &amp; <span class="kw-2">mut </span>Deployment , on : &amp; Arc &lt; RwLock &lt; <span class="kw">impl </span>Host + <span class="lifetime">&#39;static </span>&gt; &gt; ,) -&gt; CustomClientPort { <span class="self">self </span>. node . create_sender (&amp; <span class="self">self </span>. port , deployment , on) . <span class="kw">await </span>} } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfNode &lt; <span class="lifetime">&#39;a </span>&gt; <span class="kw">for </span>CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">type </span>Port = CLIDeployPort &lt; <span class="self">Self </span>&gt; ; <span class="kw">type </span>Meta = HashMap &lt; usize , Vec &lt; u32 &gt; &gt; ; <span class="kw">fn </span>id (&amp; <span class="self">self</span>) -&gt; usize { <span class="self">self </span>. id } <span class="kw">fn </span>graph_builder (&amp; <span class="self">self</span>) -&gt; (&amp; <span class="lifetime">&#39;a </span>RefCell &lt; usize &gt; , &amp; <span class="lifetime">&#39;a </span>Builders) { <span class="self">self </span>. builder . builder_components () } <span class="kw">fn </span>next_port (&amp; <span class="self">self</span>) -&gt; CLIDeployPort &lt; <span class="self">Self </span>&gt; { <span class="kw">let </span>next_port = * <span class="self">self </span>. next_port . borrow () ; * <span class="self">self </span>. next_port . borrow_mut () += <span class="number">1 </span>; CLIDeployPort { node : <span class="self">self </span>. clone () , port : format ! (<span class="string">&quot;port_{}&quot; </span>, next_port) , } } <span class="kw">fn </span>update_meta (&amp; <span class="kw-2">mut </span><span class="self">self </span>, meta : &amp; <span class="self">Self </span>:: Meta) { <span class="kw">let </span><span class="kw-2">mut </span>n = <span class="self">self </span>. underlying . try_write () . unwrap () ; n . update_meta (HydroflowPlusMeta { clusters : meta . clone () , subgraph_id : <span class="self">self </span>. id , }) ; } } <span class="kw">pub use crate </span>:: deploy :: DeployClusterNode ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>DeployCrateWrapper <span class="kw">for </span>DeployClusterNode { <span class="kw">fn </span>underlying (&amp; <span class="self">self</span>) -&gt; Arc &lt; RwLock &lt; HydroflowCrateService &gt; &gt; { <span class="self">self </span>. underlying . clone () } } <span class="kw">pub use crate </span>:: deploy :: CLIDeployCluster ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfNode &lt; <span class="lifetime">&#39;a </span>&gt; <span class="kw">for </span>CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">type </span>Port = CLIDeployPort &lt; <span class="self">Self </span>&gt; ; <span class="kw">type </span>Meta = HashMap &lt; usize , Vec &lt; u32 &gt; &gt; ; <span class="kw">fn </span>id (&amp; <span class="self">self</span>) -&gt; usize { <span class="self">self </span>. id } <span class="kw">fn </span>graph_builder (&amp; <span class="self">self</span>) -&gt; (&amp; <span class="lifetime">&#39;a </span>RefCell &lt; usize &gt; , &amp; <span class="lifetime">&#39;a </span>Builders) { <span class="self">self </span>. builder . builder_components () } <span class="kw">fn </span>next_port (&amp; <span class="self">self</span>) -&gt; CLIDeployPort &lt; <span class="self">Self </span>&gt; { <span class="kw">let </span>next_port = * <span class="self">self </span>. next_port . borrow () ; * <span class="self">self </span>. next_port . borrow_mut () += <span class="number">1 </span>; CLIDeployPort { node : <span class="self">self </span>. clone () , port : format ! (<span class="string">&quot;port_{}&quot; </span>, next_port) , } } <span class="kw">fn </span>update_meta (&amp; <span class="kw-2">mut </span><span class="self">self </span>, meta : &amp; <span class="self">Self </span>:: Meta) { <span class="kw">let </span>meta = HydroflowPlusMeta { clusters : meta . clone () , subgraph_id : <span class="self">self </span>. id , } ; <span class="self">self </span>. nodes . iter () . for_each (| n | { <span class="kw">let </span><span class="kw-2">mut </span>n = n . underlying . try_write () . unwrap () ; n . update_meta (&amp; meta) ; }) ; } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfCluster &lt; <span class="lifetime">&#39;a </span>&gt; <span class="kw">for </span>CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>ids (&amp; <span class="self">self</span>) -&gt; <span class="kw">impl </span>stageleft :: Quoted &lt; <span class="lifetime">&#39;a </span>, &amp; <span class="lifetime">&#39;a </span>Vec &lt; u32 &gt; &gt; + Copy + <span class="lifetime">&#39;a </span>{ q ! (panic ! ()) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfSendOneToOne &lt; <span class="lifetime">&#39;a </span>, CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; <span class="kw">for </span>CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>connect (&amp; <span class="self">self </span>, other : &amp; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; , source_port : &amp; CLIDeployPort &lt; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; , recipient_port : &amp; CLIDeployPort &lt; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ,) { <span class="kw">let </span><span class="kw-2">mut </span>source_port = <span class="self">self </span>. underlying . try_read () . unwrap () . get_port (source_port . port . clone () , &amp; <span class="self">self </span>. underlying) ; <span class="kw">let </span><span class="kw-2">mut </span>recipient_port = other . underlying . try_read () . unwrap () . get_port (recipient_port . port . clone () , &amp; other . underlying) ; source_port . send_to (&amp; <span class="kw-2">mut </span>recipient_port) ; } <span class="kw">fn </span>gen_sink_statement (&amp; <span class="self">self </span>, _port : &amp; <span class="self">Self </span>:: Port) -&gt; hydroflow_plus :: lang :: parse :: Pipeline { parse_quote ! (null ()) } <span class="kw">fn </span>gen_source_statement (_other : &amp; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; , _port : &amp; <span class="self">Self </span>:: Port ,) -&gt; hydroflow_plus :: lang :: parse :: Pipeline { parse_quote ! (null ()) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfSendManyToOne &lt; <span class="lifetime">&#39;a </span>, CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; <span class="kw">for </span>CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>connect (&amp; <span class="self">self </span>, other : &amp; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; , source_port : &amp; CLIDeployPort &lt; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; , recipient_port : &amp; CLIDeployPort &lt; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ,) { <span class="kw">let </span><span class="kw-2">mut </span>recipient_port = other . underlying . try_read () . unwrap () . get_port (recipient_port . port . clone () , &amp; other . underlying) . merge () ; <span class="kw">for </span>(i , node) <span class="kw">in </span><span class="self">self </span>. nodes . iter () . enumerate () { <span class="kw">let </span>source_port = node . underlying . try_read () . unwrap () . get_port (source_port . port . clone () , &amp; node . underlying) ; TaggedSource { source : Arc :: new (RwLock :: new (source_port)) , tag : i <span class="kw">as </span>u32 , } . send_to (&amp; <span class="kw-2">mut </span>recipient_port) ; } } <span class="kw">fn </span>gen_sink_statement (&amp; <span class="self">self </span>, _port : &amp; <span class="self">Self </span>:: Port) -&gt; hydroflow_plus :: lang :: parse :: Pipeline { parse_quote ! (null ()) } <span class="kw">fn </span>gen_source_statement (_other : &amp; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; , _port : &amp; CLIDeployPort &lt; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ,) -&gt; hydroflow_plus :: lang :: parse :: Pipeline { parse_quote ! (null ()) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfSendOneToMany &lt; <span class="lifetime">&#39;a </span>, CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; <span class="kw">for </span>CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>connect (&amp; <span class="self">self </span>, other : &amp; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; , source_port : &amp; CLIDeployPort &lt; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; &gt; , recipient_port : &amp; CLIDeployPort &lt; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ,) { <span class="kw">let </span><span class="kw-2">mut </span>source_port = <span class="self">self </span>. underlying . try_read () . unwrap () . get_port (source_port . port . clone () , &amp; <span class="self">self </span>. underlying) ; <span class="kw">let </span><span class="kw-2">mut </span>recipient_port = DemuxSink { demux : other . nodes . iter () . enumerate () . map (| (id , c) | { <span class="kw">let </span>n = c . underlying . try_read () . unwrap () ; (id <span class="kw">as </span>u32 , Arc :: new (RwLock :: new (n . get_port (recipient_port . port . clone () , &amp; c . underlying) ,)) <span class="kw">as </span>Arc &lt; RwLock &lt; <span class="kw">dyn </span>HydroflowSink + <span class="lifetime">&#39;static </span>&gt; &gt; ,) }) . collect () , } ; source_port . send_to (&amp; <span class="kw-2">mut </span>recipient_port) ; } <span class="kw">fn </span>gen_sink_statement (&amp; <span class="self">self </span>, _port : &amp; <span class="self">Self </span>:: Port) -&gt; hydroflow_plus :: lang :: parse :: Pipeline { parse_quote ! (null ()) } <span class="kw">fn </span>gen_source_statement (_other : &amp; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; , _port : &amp; CLIDeployPort &lt; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ,) -&gt; hydroflow_plus :: lang :: parse :: Pipeline { parse_quote ! (null ()) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; HfSendManyToMany &lt; <span class="lifetime">&#39;a </span>, CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; <span class="kw">for </span>CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">fn </span>connect (&amp; <span class="self">self </span>, other : &amp; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; , source_port : &amp; CLIDeployPort &lt; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; , recipient_port : &amp; CLIDeployPort &lt; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ,) { <span class="kw">for </span>(i , sender) <span class="kw">in </span><span class="self">self </span>. nodes . iter () . enumerate () { <span class="kw">let </span>source_port = sender . underlying . try_read () . unwrap () . get_port (source_port . port . clone () , &amp; sender . underlying) ; <span class="kw">let </span><span class="kw-2">mut </span>recipient_port = DemuxSink { demux : other . nodes . iter () . enumerate () . map (| (id , c) | { <span class="kw">let </span>n = c . underlying . try_read () . unwrap () ; (id <span class="kw">as </span>u32 , Arc :: new (RwLock :: new (n . get_port (recipient_port . port . clone () , &amp; c . underlying) . merge () ,)) <span class="kw">as </span>Arc &lt; RwLock &lt; <span class="kw">dyn </span>HydroflowSink + <span class="lifetime">&#39;static </span>&gt; &gt; ,) }) . collect () , } ; TaggedSource { source : Arc :: new (RwLock :: new (source_port)) , tag : i <span class="kw">as </span>u32 , } . send_to (&amp; <span class="kw-2">mut </span>recipient_port) ; } } <span class="kw">fn </span>gen_sink_statement (&amp; <span class="self">self </span>, _port : &amp; <span class="self">Self </span>:: Port) -&gt; hydroflow_plus :: lang :: parse :: Pipeline { parse_quote ! (null ()) } <span class="kw">fn </span>gen_source_statement (_other : &amp; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; , _port : &amp; CLIDeployPort &lt; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; &gt; ,) -&gt; hydroflow_plus :: lang :: parse :: Pipeline { parse_quote ! (null ()) } } <span class="kw">type </span>CrateBuilder &lt; <span class="lifetime">&#39;a </span>&gt; = <span class="kw">dyn </span>FnMut () -&gt; Arc &lt; RwLock &lt; HydroflowCrateService &gt; &gt; + <span class="lifetime">&#39;a </span>; <span class="kw">pub use crate </span>:: deploy :: CLIDeployNodeBuilder ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; CLIDeployNodeBuilder &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">pub fn </span>new &lt; F : FnMut () -&gt; Arc &lt; RwLock &lt; HydroflowCrateService &gt; &gt; + <span class="lifetime">&#39;a </span>&gt; (f : F) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>(RefCell :: new (Box :: new (f))) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>: <span class="lifetime">&#39;b </span>, <span class="lifetime">&#39;b </span>&gt; NodeBuilder &lt; <span class="lifetime">&#39;a </span>, CLIDeploy &gt; <span class="kw">for </span>CLIDeployNodeBuilder &lt; <span class="lifetime">&#39;b </span>&gt; { <span class="kw">fn </span>build (&amp; <span class="self">self </span>, id : usize , builder : &amp; <span class="lifetime">&#39;a </span>GraphBuilder &lt; <span class="lifetime">&#39;a </span>, CLIDeploy &gt; , _meta : &amp; <span class="kw-2">mut </span>HashMap &lt; usize , Vec &lt; u32 &gt; &gt; ,) -&gt; CLIDeployNode &lt; <span class="lifetime">&#39;a </span>&gt; { CLIDeployNode { id , builder , next_port : Rc :: new (RefCell :: new (<span class="number">0</span>)) , underlying : (<span class="self">self </span>. <span class="number">0 </span>. borrow_mut ()) () , } } } <span class="kw">type </span>ClusterBuilderFn &lt; <span class="lifetime">&#39;a </span>&gt; = <span class="kw">dyn </span>FnMut () -&gt; Vec &lt; Arc &lt; RwLock &lt; HydroflowCrateService &gt; &gt; &gt; + <span class="lifetime">&#39;a </span>; <span class="kw">pub use crate </span>:: deploy :: CLIDeployClusterBuilder ; # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>&gt; CLIDeployClusterBuilder &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">pub fn </span>new &lt; F : FnMut () -&gt; Vec &lt; Arc &lt; RwLock &lt; HydroflowCrateService &gt; &gt; &gt; + <span class="lifetime">&#39;a </span>&gt; (f : F) -&gt; <span class="self">Self </span>{ <span class="self">Self </span>(RefCell :: new (Box :: new (f))) } } # [cfg (feature = <span class="string">&quot;macro&quot;</span>)] <span class="kw">impl </span>&lt; <span class="lifetime">&#39;a </span>: <span class="lifetime">&#39;b </span>, <span class="lifetime">&#39;b </span>&gt; ClusterBuilder &lt; <span class="lifetime">&#39;a </span>, CLIDeploy &gt; <span class="kw">for </span>CLIDeployClusterBuilder &lt; <span class="lifetime">&#39;b </span>&gt; { <span class="kw">fn </span>build (&amp; <span class="self">self </span>, id : usize , builder : &amp; <span class="lifetime">&#39;a </span>GraphBuilder &lt; <span class="lifetime">&#39;a </span>, CLIDeploy &gt; , meta : &amp; <span class="kw-2">mut </span>HashMap &lt; usize , Vec &lt; u32 &gt; &gt; ,) -&gt; CLIDeployCluster &lt; <span class="lifetime">&#39;a </span>&gt; { <span class="kw">let </span>cluster_nodes = (<span class="self">self </span>. <span class="number">0 </span>. borrow_mut ()) () ; meta . insert (id , (<span class="number">0 </span>.. (cluster_nodes . len () <span class="kw">as </span>u32)) . collect ()) ; CLIDeployCluster { id , builder , next_port : Rc :: new (RefCell :: new (<span class="number">0</span>)) , nodes : cluster_nodes . into_iter () . map (| u | DeployClusterNode { underlying : u }) . collect () , } } } } # [cfg (feature = <span class="string">&quot;deploy&quot;</span>)] <span class="kw">pub use </span>deploy :: * ; <span class="kw">pub use </span>serde :: { Deserialize , Serialize } ; <span class="kw">pub use crate </span>:: HydroflowPlusMeta ;</code></pre></div></section></main></body></html>