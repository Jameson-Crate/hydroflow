<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Blocking Ops and Stratification - The Hydroflow Book</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="quickstart.html"><strong aria-hidden="true">2.</strong> Quickstart</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="setup.html"><strong aria-hidden="true">2.1.</strong> Setup</a></li><li class="chapter-item expanded "><a href="example_1_simplest.html"><strong aria-hidden="true">2.2.</strong> Simplest Example</a></li><li class="chapter-item expanded "><a href="example_2_simple.html"><strong aria-hidden="true">2.3.</strong> Simple Example</a></li><li class="chapter-item expanded "><a href="example_3_stream.html"><strong aria-hidden="true">2.4.</strong> A Example With Streaming Input</a></li><li class="chapter-item expanded "><a href="example_4_neighbors.html"><strong aria-hidden="true">2.5.</strong> Graph Neighbors</a></li><li class="chapter-item expanded "><a href="example_5_reachability.html"><strong aria-hidden="true">2.6.</strong> Graph Reachability</a></li><li class="chapter-item expanded "><a href="example_6_unreachability.html"><strong aria-hidden="true">2.7.</strong> Graph Un-Reachability</a></li><li class="chapter-item expanded "><a href="example_7_echo_server.html"><strong aria-hidden="true">2.8.</strong> Networked Services 1: EchoServer</a></li><li class="chapter-item expanded "><a href="example_8_chat_server.html"><strong aria-hidden="true">2.9.</strong> Networked Services 2: ChatServer</a></li></ol></li><li class="chapter-item expanded "><a href="concepts.html"><strong aria-hidden="true">3.</strong> Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="life_and_times.html"><strong aria-hidden="true">3.1.</strong> Life and Times of Hydroflow</a></li><li class="chapter-item expanded "><a href="stratification.html" class="active"><strong aria-hidden="true">3.2.</strong> Blocking Ops and Stratification</a></li><li class="chapter-item expanded "><a href="distributed_time.html"><strong aria-hidden="true">3.3.</strong> Distributed Time</a></li></ol></li><li class="chapter-item expanded "><a href="ecosystem.html"><strong aria-hidden="true">4.</strong> The Hydro Ecosystem</a></li><li class="chapter-item expanded affix "><li class="part-title">User Guide</li><li class="chapter-item expanded "><a href="surface_syntax.html"><strong aria-hidden="true">5.</strong> Syntax</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="surface_embedding.html"><strong aria-hidden="true">5.1.</strong> Rust Embedding</a></li><li class="chapter-item expanded "><a href="surface_flows.html"><strong aria-hidden="true">5.2.</strong> Flows</a></li><li class="chapter-item expanded "><a href="surface_data.html"><strong aria-hidden="true">5.3.</strong> Data Sources</a></li><li class="chapter-item expanded "><a href="surface_ops.gen.html"><strong aria-hidden="true">5.4.</strong> Operators</a></li></ol></li><li class="chapter-item expanded "><a href="architecture.html"><strong aria-hidden="true">6.</strong> Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="in-out_trees.html"><strong aria-hidden="true">6.1.</strong> Subgraph In-Out Trees</a></li></ol></li><li class="chapter-item expanded "><a href="todo.html"><strong aria-hidden="true">7.</strong> TODO</a></li><li class="chapter-item expanded "><a href="state.html"><strong aria-hidden="true">8.</strong> State and Lifetimes</a></li><li class="chapter-item expanded "><a href="debugging.html"><strong aria-hidden="true">9.</strong> Debugging</a></li><li class="chapter-item expanded "><a href="error_handling.html"><strong aria-hidden="true">10.</strong> Error Handling</a></li><li class="chapter-item expanded "><a href="faq.html"><strong aria-hidden="true">11.</strong> FAQ</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Hydroflow Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="streaming-blocking-and-stratification"><a class="header" href="#streaming-blocking-and-stratification">Streaming, Blocking and Stratification</a></h1>
<p>Many Hydroflow operators (e.g. <code>map</code>, <code>filter</code> and <code>join</code>) work in a streaming fashion. Streaming operators process data as it arrives, generating outputs in the midst of processing inputs. If you restrict yourself to operators that work in this streaming fashion, then your transducer may start sending data across the network mid-tick, even while it is still consuming the data in the input batch.</p>
<p>But some operators are blocking, and must wait for all their input data to arrive before they can produce any output data. For example, a <code>sort</code> operator must wait for all its input data to arrive before it can produce a single output value. (After all, the lowest value may be the last to arrive!)</p>
<h2 id="examples-of-blocking-operators"><a class="header" href="#examples-of-blocking-operators">Examples of Blocking Operators</a></h2>
<p>As an example, consider the <code>sort</code> operator. It must wait for all the input data to arrive before it can produce any output data---after all, the lowest value may be the last to arrive! </p>
<p>This should raise questions in your mind. What do we mean by &quot;all the input data&quot; in a long-running service? We don't want to wait until the end of time—this is one reason we break time up into discrete &quot;ticks&quot; at each transducer. So when we say that a blocking operator waits for &quot;all the input data&quot;, we mean &quot;all the input data in the current tick&quot;.</p>
<p>Consider the simple statement below, which receives data from a network source each tick, sorts that tick's worth of data, and prints it to stdout:</p>
<pre><code class="language-rust ignore">source_stream_serde(inbound) -&gt; sort() -&gt; for_each(|x| println!(&quot;{:?}&quot;, x));
</code></pre>
<p>The runtime determines arbitrarily what batch of data is taken from the channel and fed into the <code>source_stream_serde</code> operator for this tick. The sort operator will need to know that the <code>source_stream_serde</code> operator has no more data to send this tick, so that it can sort the data that got buffered and then send the sorted data to the <code>for_each</code> operator, which prints it to stdout. To do this, the runtime provides a mechanism for the <code>source_stream_serde</code> operator to buffer its output and notify the <code>sort</code> operator that it has no more data to send. This is called a <em>handoff</em>.</p>
<p>You can see the mermaid graph for the statement above just below this paragraph. Notice the two outer yellow boxes and the handoff between them. Each yellow boxes is a subflow that is
assigned a <em>stratum</em> number. (&quot;Stratum&quot; is latin for &quot;layer&quot;; the plural of &quot;stratum&quot; is &quot;strata&quot;.) </p>
<pre class="mermaid">flowchart LR
    subgraph &quot;sg_1v1 stratum 0&quot;
        1v1[&quot;1v1 &lt;tt&gt;op_1v1: source_stream_serde(inbound)&lt;/tt&gt;&quot;]
    end
    subgraph &quot;sg_2v1 stratum 1&quot;
        2v1[&quot;2v1 &lt;tt&gt;op_2v1: sort()&lt;/tt&gt;&quot;]
        3v1[&quot;3v1 &lt;tt&gt;op_3v1: for_each(| (x) | println! (&amp;quot;{:?}&amp;quot;, x))&lt;/tt&gt;&quot;]
    end

    4v1{&quot;handoff&quot;}

    1v1--&gt;4v1
    2v1--&gt;3v1
    4v1--&gt;2v1
</pre>
<p>At compile time, the Hydroflow spec is <em>stratified</em>: partitioned into subflows, where each subflow is assigned a stratum number. Subsequently at runtime, each tick executes the strata one-by-one in ascending order of stratum number. In the example above, the <code>source_stream_serde</code> operator is in stratum 0, and the <code>sort</code> and <code>for_each</code> operators are in stratum 1. The runtime executes the <code>source_stream_serde</code> operator first, buffering output in the Handoff. The <code>sort</code> operator will not receive any data until the <code>source_stream_serde</code> operator has finished executing. When stratum 0 is complete, the subflow in stratum 1 is scheduled and executes the <code>sort</code> and <code>for_each</code> operators to complete the tick. </p>
<p>The <a href="./surface_ops.gen.html#difference"><code>difference</code></a> operator is a mixed example. Like a set difference, it outputs all the items from its <code>pos</code> input that do not appear in its <code>neg</code> input. The <code>pos</code> input is streaming, and the <code>neg</code> input is blocking. Blocking on the <code>neg</code> input ensures that if the operator streams an output from the <code>pos</code> input, it will never need to retract that output.</p>
<p>This allows us to refine our understanding of the Hydroflow transducer loop:</p>
<ol>
<li>Ingest a batch of data from one or more inbound channels, deliver them to the appropriate <code>source_xxx</code> operators in the Hydroflow spec.</li>
<li>For each stratum [0..n] in the Hydroflow spec, run the stratum to fixpoint, placing any outputs into handoffs or outbound channels. </li>
<li>Advance the local clock before starting the next tick.</li>
</ol>
<h2 id="technical-details"><a class="header" href="#technical-details">Technical Details</a></h2>
<p>The concept of stratification is taken directly from stratified negation in <a href="https://en.wikipedia.org/wiki/Datalog">Datalog</a>, but Hydroflow applies it to any blocking operator, not just negation.</p>
<p>The Hydroflow compiler performs stratification via static analysis of the Hydroflow spec. The analysis is based on the following rules:</p>
<ul>
<li>A Handoff is interposed in front of any blocking input to an operator (as documented in the <a href="./surface_ops.gen.html">operator definitions</a>.</li>
<li>The flow is partitioned at the Handoffs into Handoff-free subflows called &quot;strata&quot;.</li>
<li>The resulting graph of strata and Handoffs is tested to ensure that it's acyclic. (Cycles through blocking operators are forbidden as they not have well-defined behavior—note that the blocking operators in a cycle would deadlock waiting for each other.)</li>
</ul>
<p>Given the acyclicity test, any legal Hydroflow program consists of a directed acyclic graph (DAG) of strata and handoffs. The strata are numbered in ascending order by assigning stratum number 0 to the &quot;leaves&quot; of the DAG (strata with no upstream operators), and then ensuring that each stratum is assigned a number that is one larger than any of its upstream strata.</p>
<p>As a Hydroflow operator executes, it is running on a particular transducer, in a particular tick, in a particular stratum. </p>
<h3 id="determining-whether-an-operator-should-block-monotonicity"><a class="header" href="#determining-whether-an-operator-should-block-monotonicity">Determining whether an operator should block: Monotonicity</a></h3>
<p>Why are some inputs to operators streaming, and others blocking? Intuitively, the blocking operators must hold off on emitting outputs early because they may receive another input that would change their output. For example, a <code>difference</code> operator on integers cannot emit the number 4 from its <code>pos</code> input if it may subsequently receive a 4  within the same tick on the <code>neg</code> input. More generally, it cannot output anything until it has received all the <code>neg</code> input data. </p>
<p>By contrast, streaming operators like <code>filter</code> have the property that they can always emit an output, <em>regardless of what other data they will receive later in the tick</em>. </p>
<p>Mathematically, we can think of a dataflow operator as a function <em>f(in) -&gt; out</em> from one batch of data to another. We call a function <a href="https://en.wikipedia.org/wiki/Monotonic_function#In_order_theory">monotone</a> if its output is a growing function of its input. That is, <em>f</em> is classified as a monotone function if <em>f(B) ⊆ f(C)</em> whenever <em>B ⊆ C</em>.</p>
<p>By contrast, consider the output of a blocking operator like <code>difference</code>. The output of <code>difference</code> is a function of its inputs, but it is <em>non-monotone</em> with respect to its <code>neg</code> input: it is NOT the case that <em>A — B ⊆ A — C</em> whenever <em>B ⊆ C</em>. </p>
<p>Hydroflow uses the monotonicity property to determine whether an operator should block. If an operator is monotone with
respect to an input, that input is streaming. If an operator is non-monotone, it is blocking.</p>
<p>Monotonicity turns out to be particularly important for distributed systems. In particular, if all your transducers are fully monotone across ticks, then they can run in parallel without any coordination—they will always stream correct prefixes of the final outputs, and eventually will deliver the complete output. This is the positive direction of the <a href="https://cacm.acm.org/magazines/2020/9/246941-keeping-calm/fulltext">CALM Theorem</a>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="life_and_times.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="distributed_time.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="life_and_times.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="distributed_time.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        <script type="text/javascript" src="mermaid.min.js"></script>
        <script type="text/javascript" src="mermaid-init.js"></script>
    </body>
</html>
